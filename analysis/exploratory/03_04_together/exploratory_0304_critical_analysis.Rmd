# ---
# title: "Analysis of ROOT & EMBEDDED QUESTIONS TOGETHER"
# author: "mcmoyer"
# date: "March 30, 2021"
# ---

## Step 1: select stimuli for experiment
```{r}
library(lme4)
library(lmerTest)
library(multcomp) # not available for this version of R
library(tidyverse)
theme_set(theme_bw())

this.dir <- dirname(rstudioapi::getSourceEditorContext()$path)
setwd(this.dir)
source("../../helpers.R")

cbPalette <- c("#56B4E9", "#D55E00", "#009E73","#999999", "#E69F00","#009E73","#56B4E9", "#D55E00", "#009E73","#999999", "#E69F00","#009E73","#56B4E9", "#D55E00", "#009E73","#999999", "#E69F00","#009E73","#56B4E9", "#D55E00", "#009E73","#999999", "#E69F00","#009E73")
```

########################################################################
# Read the data into R.
```{r}
rq = read.csv("../../03_experiment/data/normed.csv")
eq = read.csv("../../04_experiment/data/normed.csv")
rq = rq[,c("workerid","tgrep_id","ModalPresent","Modal","QuestionType","Question","Sentence","paraphrase","rating","Finite","Wh")]
eq = eq[,c("workerid","tgrep_id","ModalPresent","Modal","QuestionType","Question","Sentence","paraphrase","rating","Finite","Wh","VerbLemma")]

rq$QuestionType = "root"
rq$VerbLemma = ""

d = rbind(rq,eq)
```


```{r}
d$ModalPresent = as.factor(d$ModalPresent)
d$Wh = as.factor(d$Wh)
d$paraphrase = as.factor(d$paraphrase)

# set the reference levels
contrasts(d$Wh) = cbind("how.vs.when"=c(0,1,0,0,0,0),"what.vs.when"=c(1,0,0,0,0,0),
                "where.vs.when"=c(0,0,0,1,0,0),"who.vs.when"=c(0,0,0,0,1,0),
                "why.vs.when"=c(0,0,0,0,0,1))

# this won't work if the 'other' category is included, so REDO
contrasts(d$paraphrase) = cbind("a.vs.every"=c(1,0,0),"the.vs.every"=c(0,0,1))

centered = d
centered$cModalPresent = as.numeric(centered$ModalPresent) - mean(as.numeric(centered$ModalPresent))
centered$cQuestionType = as.numeric(centered$QuestionType) - mean(as.numeric(centered$QuestionType))

```

```{r}
########################################################################
# model with random slopes no matrix verb predictor
m.full = lmer(rating ~ cModalPresent*Wh*paraphrase + (1+paraphrase+Wh+cModalPresent|workerid) + (1+paraphrase|tgrep_id), data=centered,REML=FALSE) 
summary(m.full)

saveRDS(m.full, "model-context-full.rds")
nocontext_model <- readRDS("model-context-full.rds")

```

########################################################################
# breaking up by wh-word so that 3-way interaction is more interpretable
########################################################################
# some of them cannot have the full random effects, so random effects
# have to be what is justified by the data
########################################################################

```{r}
########################################################################
# "what" model
d_what = centered %>% 
  filter(Wh=="what") %>% 
  droplevels()

m.what = lmer(normed_rating ~ cModalPresent*paraphrase*cQuestionType + (1+paraphrase+cModalPresent|workerid) + (1+paraphrase|VerbLemma) + (1+paraphrase|tgrep_id), data=d_what) 
summary(m.what)

saveRDS(m.what, "QT_what.rds")
model_what <- readRDS("QT_what.rds")
summary(model_what)

# m.what.simple = lmer(normed_rating ~ paraphrase*cModalPresent-cModalPresent + (1+paraphrase+cModalPresent|workerid) + (1+paraphrase|VerbLemma)  + (1+paraphrase|tgrep_id), data=d_what) 
# summary(m.what.simple)

########################################################################
# "how" model
d_how = centered %>% 
  filter(Wh=="how") %>% 
  droplevels()

m.how = lmer(normed_rating ~ cModalPresent*paraphrase*cQuestionType + (1+paraphrase+cModalPresent|workerid) + (1+paraphrase|VerbLemma)  + (1+paraphrase|tgrep_id), data=d_how) 
summary(m.how)

saveRDS(m.how, "QT_how.rds")
model_how <- readRDS("QT_how.rds")

# m.how.simple = lmer(normed_rating ~ paraphrase*cModalPresent-cModalPresent + (1+paraphrase|tgrep_id), data=d_how) 
# summary(m.how.simple)

########################################################################
# "where" model
d_where = centered %>% 
  filter(Wh=="where") %>% 
  droplevels()

m.where = lmer(normed_rating ~ cModalPresent*paraphrase*cQuestionType + (1+paraphrase+cModalPresent|workerid) + (1+paraphrase|VerbLemma) + (1+paraphrase|tgrep_id), data=d_where) 
summary(m.where)

saveRDS(m.where, "QT_where.rds")
model_where <- readRDS("QT_where.rds")

# m.where.simple = lmer(normed_rating ~ paraphrase*cModalPresent-cModalPresent + (1+paraphrase+cModalPresent|workerid) + (1+paraphrase|tgrep_id), data=d_where) 
# summary(m.where.simple)

########################################################################
# "why" model
d_why = centered %>% 
  filter(Wh=="why") %>% 
  droplevels()

m.why = lmer(normed_rating ~ cModalPresent*paraphrase*cQuestionType + (1+paraphrase+cModalPresent|workerid) + (1+paraphrase|VerbLemma) + (1+paraphrase|tgrep_id), data=d_why) 
summary(m.why)

saveRDS(m.why, "QT_why.rds")
model_why <- readRDS("QT_why.rds")

# m.why.simple = lmer(rating ~ paraphrase*cQuestionType*cModalPresent-cModalPresent + (1+paraphrase+cModalPresent|workerid) + (1+paraphrase|tgrep_id), data=d_why) 
# summary(m.why.simple)

########################################################################
# "who" model
d_who = centered %>% 
  filter(Wh=="who") %>% 
  droplevels()

m.who = lmer(normed_rating ~ cModalPresent*paraphrase*cQuestionType + (1+paraphrase|workerid)+ (1+paraphrase|VerbLemma) + (1+paraphrase|tgrep_id), data=d_who) 
summary(m.who)

saveRDS(m.who, "QT_who.rds")
model_who <- readRDS("QT_who.rds")

# m.who.simple = lmer(normed_rating ~ paraphrase*cModalPresent-cModalPresent + (1+paraphrase|workerid) + (1+paraphrase|tgrep_id), data=d_who) 
# summary(m.who.simple)

########################################################################
# "when" model
# have to use less random effects structure
d_when = centered %>% 
  filter(Wh=="when") %>% 
  droplevels()

m.when = lmer(normed_rating ~ cModalPresent*paraphrase*cQuestionType + (1+paraphrase|VerbLemma) + (1+paraphrase|tgrep_id), data=d_when) 
summary(m.when)

saveRDS(m.when, "QT_when.rds")
model_when <- readRDS("QT_when.rds")

# simple effects
# m.when.simple = lmer(normed_rating ~ paraphrase*cModalPresent-cModalPresent + (1+paraphrase|tgrep_id), data=d_when) 
# summary(m.when.simple)
# 
```


########################################################################
########################################################################
########################################################################
# definite and indefinite
# Read database
corp = read.table("../../corpus/results/swbd.tab",sep="\t",header=T,quote="")
names(corp)[names(corp) == "Item_ID"] <- "tgrep_id"
# join dfs together
d <- left_join(d, corp_match, by="tgrep_id")

d$DeterminerSubject = as.factor(d$DeterminerSubject)
d$DeterminerSubjPresent = as.factor(d$DeterminerSubjPresent)
str(d$DeterminerSubjPresent)
d$DeterminerNonSubject = as.factor(d$DeterminerNonSubject)
d$DeterminerNonSubjPresent = as.factor(d$DeterminerNonSubjPresent)
names(d)
det_sbj = d %>%
  filter(DeterminerSubjPresent != "no")
View(det_sbj)

str(d$DeterminerSubjPresent)

det_non_sbj = d %>%
  filter(DeterminerNonSubjPresent == "no")
